<!-- Messages Display -->
{% if messages %}
  <div class="messages-container mb-3">
    {% for message in messages %}
      {% if message.tags == 'success' %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% elif message.tags == 'error' %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% elif message.tags == 'warning' %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% elif message.tags == 'info' %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% else %}
        <div class="alert alert-primary alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}

<div class="page-header">
  <h3 class="page-title">
    <span class="page-title-icon bg-gradient-primary text-white me-2"><i class="mdi mdi-chair-school"></i></span>
    Hall Allocation Details
  </h3>
  <nav aria-label="breadcrumb">
    <ul class="breadcrumb flex gap-3 align-items-center">
      <li>
        <a hx-get="{% url 'allocation' %}" 
           hx-vals='{"date": "{{ date }}", "period": "{{ period }}"}' 
           hx-target="#main-content"
            hx-push-url="true"
           class="btn bg-secondary text-white">
          <i class="mdi mdi-arrow-left"></i> Back to Summary
        </a>
      </li>
      {% if generated and hall_id %}
        <li>
          <a href="{% url 'export_arrangement' %}?date={{ date }}&period={{ period }}" class="btn bg-gradient-primary text-white">Export</a>
        </li>
        <li>
          <a href="{% url 'generate_attendance_sheets' %}?date={{ date }}&period={{ period }}&hall_id={{ hall_id }}" class="btn bg-success text-white">Generate Attendance Sheets</a>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>



{% if generated and selected_hall %}
  <div class="d-flex justify-content-between align-items-center">
    <h3>
      {{ selected_hall.name }} - Seat Allocation
      {% if request.GET.date %}
        {{ request.GET.date }}
      {% else %}
        {{ dates|first }}
      {% endif %}
      {% if request.GET.period %}
        {{ request.GET.period }}
      {% else %}
        AM
      {% endif %}
    </h3>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5>{{ selected_hall.name }} - Seating Arrangement</h5>
          <small class="text-muted">Capacity: {{ hall_capacity }} seats</small>
        </div>
        <div class="card-body">
          {% if seat_grid %}
            <!-- Course Legend -->
            <div class="mb-3">
              <h6>Course Legend:</h6>
              <div class="d-flex flex-wrap gap-2" id="course-legend">
                <!-- Legend items will be populated by JavaScript -->
              </div>
            </div>
            
            <!-- Hall Layout -->
            <div class="hall-layout">
              <div class="hall-orientation mb-2">
                <div class="text-center">
                  <small class="text-muted">FRONT OF HALL</small>
                </div>
              </div>
              
              <div class="seat-grid">
                {% for row in seat_grid %}
                  <div class="seat-row d-flex justify-content-center mb-1">
                    {% for seat in row %}
                      <div class="seat m-1 p-2 border rounded text-center" 
                           style="width: 40px; height: 40px; font-size: 10px; {% if not seat.is_occupied %}background-color: white; color: #333;{% endif %}" 
                           title="{% if seat.is_occupied %}Seat {{ seat.seat_number }}: {{ seat.student.first_name }} {{ seat.student.last_name }} ({{ seat.course.code }}){% else %}Seat {{ seat.seat_number }}: Empty{% endif %}">
                        {{ seat.seat_number }}
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
              
              <div class="hall-orientation mt-2">
                <div class="text-center">
                  <small class="text-muted">BACK OF HALL</small>
                </div>
              </div>
            </div>
          {% else %}
            <p class="text-muted">No seating arrangement available for this hall.</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <!-- Hall Statistics -->
      <div class="card mb-3">
        <div class="card-header">
          <h6>Hall Statistics</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-6">
              <div class="text-center">
                <h4 class="text-success">{{ placed_students.count }}</h4>
                <small>Placed</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center">
                <h4 class="text-warning">{{ unplaced_students.count }}</h4>
                <small>Unplaced</small>
              </div>
            </div>
          </div>
          <hr>
          <div class="text-center">
            <h5>{{ hall_capacity }}</h5>
            <small>Total Capacity</small>
          </div>
        </div>
      </div>
      
      <!-- Unplaced Students -->
      {% if unplaced_students %}
        <div class="card">
          <div class="card-header">
            <h6>Unplaced Students ({{ unplaced_students.count }})</h6>
            <small class="text-muted">Manually assign students to available seats</small>
          </div>
          
          <!-- Instructions -->
          <div class="card-body border-bottom bg-light py-2">
            <div class="d-flex align-items-center">
              <i class="mdi mdi-information text-info me-2"></i>
              <small class="text-muted">
                <strong>How to assign:</strong> 
                Click on any <span class="badge bg-success">available seat</span> in the hall layout above, 
                or use the dropdown to select a seat number. 
                The system will enforce adjacency constraints automatically.
              </small>
            </div>
          </div>
          
          <div class="card-body" style="max-height: 500px; overflow-y: auto;">
             {% for student in unplaced_students %}
               <div class="mb-3 manual-assignment-card border rounded">
                 <div class="student-info mb-2">
                   <div class="d-flex justify-content-between align-items-start">
                     <div>
                       <strong class="text-dark">{{ student.student.first_name }} {{ student.student.last_name }}</strong><br>
                       <small class="text-muted">{{ student.student.matric_no }}</small><br>
                       <span class="badge bg-info">{{ student.course.code }}</span>
                     </div>
                     <div class="text-end">
                       <small class="text-muted">Student {{ forloop.counter }}</small>
                     </div>
                   </div>
                 </div>
                 
                 <!-- Manual Assignment Form -->
                 <div class="assignment-form">
                   <form method="post" action="{% url 'manual_seat_assignment' %}">
                     {% csrf_token %}
                     <input type="hidden" name="student_id" value="{{ student.id }}">
                     <input type="hidden" name="date" value="{{ date }}">
                     <input type="hidden" name="period" value="{{ period }}">
                     <input type="hidden" name="hall_id" value="{{ hall_id }}">
                     
                     <div class="row align-items-end g-2">
                       <div class="col-md-8">
                         <label for="seat_{{ student.id }}" class="form-label small fw-bold mb-1">
                           <i class="mdi mdi-chair-school"></i> Assign to Seat:
                         </label>
                         <select name="seat_number" id="seat_{{ student.id }}" class="form-select form-select-sm" required>
                           <option value="">Click on available seat or select...</option>
                           <!-- Available seats will be populated by JavaScript -->
                         </select>
                       </div>
                       <div class="col-md-4">
                         <button type="submit" class="btn btn-success btn-sm w-100">
                           <i class="mdi mdi-account-plus"></i> Assign
                         </button>
                       </div>
                     </div>
                   </form>
                 </div>
               </div>
             {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
{% else %}
  <div class="alert alert-info">
    <i class="mdi mdi-information"></i>
    No allocation data available. Please generate seat allocation first.
  </div>
{% endif %}

<style>
.seat {
  cursor: pointer;
  transition: all 0.2s ease;
}

.seat:hover {
  transform: scale(1.1);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.hall-layout {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  border: 2px solid #dee2e6;
}

.seat-grid {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.legend-item {
  display: inline-flex;
  align-items: center;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  margin: 2px;
}

.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 2px;
  margin-right: 6px;
}

/* Manual Assignment Styles */
.manual-assignment-card {
  transition: all 0.3s ease;
}

.manual-assignment-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.available-seat {
  animation: pulse-available 2s infinite;
}

@keyframes pulse-available {
  0% { border-color: #28a745; }
  50% { border-color: #20c997; }
  100% { border-color: #28a745; }
}

.seat-selected {
  background-color: #ffc107 !important;
  border-color: #fd7e14 !important;
  animation: none;
}

.assignment-form {
  background: rgba(255, 255, 255, 0.8);
  border-radius: 8px;
  padding: 10px;
}

.student-info {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 6px;
  padding: 8px;
}
</style>

<script>
// JavaScript for course legend, seat coloring, and manual assignment
document.addEventListener('DOMContentLoaded', function() {
    // Define a set of colors for courses
    const colors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
        '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
        '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#D7BDE2'
    ];
    
    // Get all seats and extract unique courses
    const seats = document.querySelectorAll('.seat[title*=":"]');
    const courses = new Set();
    const occupiedSeats = new Set();
    const availableSeats = [];
    
    // Get hall capacity from context
    const hallCapacity = {{ hall_capacity|default:0 }};
    
    seats.forEach(seat => {
        const title = seat.getAttribute('title');
        const seatNumber = parseInt(seat.textContent.trim());
        
        if (title && title.includes('(') && title.includes(')')) {
            const courseMatch = title.match(/\(([^)]+)\)/);
            if (courseMatch) {
                courses.add(courseMatch[1]);
                occupiedSeats.add(seatNumber);
            }
        }
    });
    
    // Generate list of available seats
    for (let i = 1; i <= hallCapacity; i++) {
        if (!occupiedSeats.has(i)) {
            availableSeats.push(i);
        }
    }
    
    // Populate seat selection dropdowns
    const seatSelects = document.querySelectorAll('select[name="seat_number"]');
    seatSelects.forEach(select => {
        availableSeats.forEach(seatNum => {
            const option = document.createElement('option');
            option.value = seatNum;
            option.textContent = `Seat ${seatNum}`;
            select.appendChild(option);
        });
    });
    
    // Create color mapping for courses
    const courseColors = {};
    Array.from(courses).forEach((course, index) => {
        courseColors[course] = colors[index % colors.length];
    });
    
    // Create legend
    const legend = document.getElementById('course-legend');
    Object.entries(courseColors).forEach(([course, color]) => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.style.backgroundColor = color + '20';
        legendItem.style.border = `1px solid ${color}`;
        legendItem.innerHTML = `
            <div class="legend-color" style="background-color: ${color}"></div>
            <span>${course}</span>
        `;
        legend.appendChild(legendItem);
    });
    
    // Apply colors to seats and make available seats clickable
    seats.forEach(seat => {
        const title = seat.getAttribute('title');
        const seatNumber = parseInt(seat.textContent.trim());
        
        if (title && title.includes('(') && title.includes(')')) {
            const courseMatch = title.match(/\(([^)]+)\)/);
            if (courseMatch) {
                const course = courseMatch[1];
                const color = courseColors[course];
                if (color) {
                    seat.style.backgroundColor = color;
                    seat.style.color = 'white';
                }
            }
        } else if (availableSeats.includes(seatNumber)) {
             // Make available seats clickable
             seat.style.backgroundColor = '#e9ecef';
             seat.style.border = '2px dashed #28a745';
             seat.style.cursor = 'pointer';
             seat.classList.add('available-seat');
             seat.title = `Seat ${seatNumber}: Available for assignment - Click to select`;
             
             seat.addEventListener('click', function() {
                 // Remove previous selections
                 document.querySelectorAll('.seat-selected').forEach(s => {
                     s.classList.remove('seat-selected');
                     if (availableSeats.includes(parseInt(s.textContent.trim()))) {
                         s.classList.add('available-seat');
                     }
                 });
                 
                 // Mark this seat as selected
                 seat.classList.remove('available-seat');
                 seat.classList.add('seat-selected');
                 
                 // Find the first unplaced student and set their seat selection
                 const firstSelect = document.querySelector('select[name="seat_number"]');
                 if (firstSelect) {
                     firstSelect.value = seatNumber;
                     firstSelect.focus();
                     
                     // Show success message
                     const studentName = firstSelect.closest('.manual-assignment-card').querySelector('.text-dark').textContent;
                     console.log(`Selected seat ${seatNumber} for ${studentName}`);
                 }
             });
        }
    });
    
    // Add visual feedback for form submissions
    const assignForms = document.querySelectorAll('form[action*="manual-seat-assignment"]');
    assignForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            const seatSelect = form.querySelector('select[name="seat_number"]');
            
            if (!seatSelect.value) {
                e.preventDefault();
                alert('Please select a seat number.');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Assigning...';
        });
    });
});
</script>
